import time
import sys
execfile('walb-config.py')
nrLoop = 5
while True:
    print 'get restorable.'
    gidL = walbc.get_restorable(a0, VOL, 'all')
    gid = gidL[-1]
    print 'wdiff statistics'
    !ls /var/walbh/a0/volh/*.wdiff |wc
    !wdiff-show -norec -nohead -stat /var/walbh/a0/volh/*.wdiff
    print 'restore expr'
    sys.stdout.flush()
    for _ in xrange(nrLoop):
        !sudo umount /var/walbh/a0real
        !sudo mount /dev/ubuntu/archiveh /var/walbh/a0real
        t0 = time.time()
        walbc.restore(a0, VOL, gid)
        t1 = time.time()
        print 'Restore time:', t1 - t0
        sys.stdout.flush()
        time.sleep(1)
        walbc._del_restored_all(a0, VOL)
        time.sleep(1)
    print 'backup'
    sys.stdout.flush()
    !sh backup-a0.sh >> backup-a0.log
    print 'apply expr'
    sys.stdout.flush()
    for _ in xrange(nrLoop):
        !sudo umount /var/walbh/a0real
        !sudo mount /dev/ubuntu/archiveh /var/walbh/a0real
        t0 = time.time()
        walbc._apply_diff_all(a0, VOL)
        t1 = time.time()
        print 'Apply time:', t1 - t0
        sys.stdout.flush()
        time.sleep(1)
        !sh restore-a0.sh >> restore-a0.log
    if len(gidL) <= 2:
        break
    print 'merge'
    sys.stdout.flush()
    !python merge.py >> merge.log
