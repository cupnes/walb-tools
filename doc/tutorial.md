# A tutorial for WalB-tools

This is a tutorial for WalB-tools.
See [README](README.md) for details.

## Abstract of WalB
See [Why WalB is hard?](https://github.com/walb-linux/walb-tools/raw/master/doc/walb-is-hard.pptx).


## Terminology

* **WalB block device (wdev)**: A block device for WalB, on which any file system can be constructed.
* **wlog**: Logs generated by WalB when data is written on wdev.
* **wdiff**: A data format transformed from wlog.
* **WalB log device (ldev)**: A block device on which wlog is written.
* **WalB data device (ddev)**: A block device on which real data is written when the data is written on wdev.
WalB handes both ldev and wdev and shows one wdev to users.
* **take a snapshot**: Assign an identifier to a status of wdev (a full disk image) at a certain moment
* **gid**: The unique 64-bit integer identifier assigned by takeing a snapshot.
* **restore**: Recover the status of wdev specified by the snapshot on a LVM volume.
* **merge**: A merge operation sorts listed wdiffs, removes duplicate data and compresses them and outputs one wdiff.
* **apply**: An apply operation updates a LVM volume contains a full disk image according to listed wdiffs and removes those wdiffs.
* **storage**: A storage server is running on wdev, which extracts wlogs from a ldev and transfers them to some proxy servers..
* **proxy**: A proxy server receives wlogs from a storage server and transforms them to wdiffs and keeps them in a disk temporarily and sends them to some archive servers.
* **archive**: An archive server receives wdiffs from a proxy server and stores them.
* **full-backup**: Transffer all data of wdev from a storage server to an archive server, and stores it as a full disk images.

* **hash-backup**: Check all data of wdev on a storage server and sends minimum differences wdiffs to an archive server.

## Configuration for this tutorial

* Run walb-storage(storage server), walb-proxy(proxy server) and walb-archive(archive server) on one PC.
  * Thease programs are not daemon.
  * A command `walbc` communicates and controls these processes,
  * `python/walblib/__init__.py` is provided for high level operations.
* Configuration of processes
  * s0(walb-storage) : port 10000
  * p0(walb-proxy) : port 10100
  * a0(walb-archive) : port 10200
* Configuration of disk
  * Use a loopback devcide for safety.
  * ![Layout](layout.png)
    * wdev : /dev/walb/walb-tutorial-device
      * ddev : /dev/tutorial/mdata
      * ldev : /dev/tutorial/mlog
    * /mnt/tutorial/s0/ : metadata and logs are stored by walb-storage.
    * /mnt/tutorial/p0/ : wdiffs are stored by walb-stproxy.
    * /mnt/tutorial/a0/ : wdiffs are stored by walb-archive.
      * A LVM snapshot generated by restore operation is `/dev/tutorial/r_vol_***`.

## How to setup VirtualBox and Vagrant

We provide a virtual WalB environment on Ubuntu 16.04 and CentOS 7.

### Install VirtualBox and Vagrant

For Ubuntu,
```
sudo apt install -y virtualbox vagrant
```

For CentOS7,
```
sudo yum install -y virtualbox vagrant
```

### Add a box file for guest OS


Select Ubuntu 16 or CentOS 7 for a guest OS.

For Ubuntu 16,
```
vagrant box add Ubuntu16 https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-vagrant.box
cd walb-tools/misc/vagrant/Ubuntu16
vagrant up
vagrant reload
```

For CentOS7,
```
vagrant box add CentOS7 http://cloud.centos.org/centos/7/vagrant/x86_64/images/CentOS-7.box
cd walb-tools/misc/vagrant/CentOS7
vagrant up
vagrant reload
```

### Login the gust OS and setup WalB

On host OS,
```
vagrant ssh
```

On guest OS,
```
./setup.sh
```
To start next tutorial, go [How to use WalB on ipython](tutorial.md#how-to-use-walb-on-ipython).

## Manual Setup

This section shows how to setup WalB manually.

### Requairements

* C++ 11 compiler such as gcc-4.8 and clang++-4.8, etc.
* ipython

For Ubuntu,
```
sudo apt install -y linux-headers-`uname -r` libaio-dev libsnappy-dev liblzma-dev zlib1g-dev python make gcc g++ ipython
```

For CentOS7,
```
sudo yum install -y git gcc gcc-c++ kernel-devel snappy-devel xz-devel libaio-devel psmisc binutils-devel wget python-devel
# install jupyter, pylint
wget https://bootstrap.pypa.io/get-pip.py
sudo python get-pip.py
sudo pip install jupyter
sudo pip install pylint
```

### Make walb-tools

```
cd
git clone git@github.com:walb-linux/walb-tools
cd walb-tools
make -j4 CC=gcc CXX=g++ core
```

### Make walb-driver

Select an appropriate branch for the version of kernel(`uname -r`) as follows:

| Branch      | Kernel version |
|-------------|----------------|
| `master`    | 4.8-           |
| `for-4.3`   | 4.3-4.7        |
| `for-3.14`  | 3.14-4.2       |
| `for-3.10`  | 3.10-3.13      |

For example, CentOS 7,

```
cd
git clone git@github.com:walb-linux/walb-driver
cd walb-driver
git co -b for-3.10 master/for-3.10
cd module
make
insmod walb-mod.ko
```

### Setup volume disk for this tutorial

```
dd if=/dev/zero of=tutorial-disk bs=1M count=100
sudo losetup /dev/loop0 tutorial-disk
sudo pvcreate /dev/loop0
sudo vgcreate tutorial /dev/loop0
sudo lvcreate -n wdata -L 10m tutorial
sudo lvcreate -n wlog -L 10m tutorial
sudo lvcreate -n data -L 20m tutorial
sudo mkfs.ext4 /dev/tutorial/data
sudo mkdir -p /mnt/tutorial
sudo mount /dev/tutorial/data ${DATA}
sudo mkdir -p /mnt/tutorial/{a0,p0,s0}
```

* WalB deals /dev/tutorial/wdata and /dev/tutorial/wlog for wdev device.
* /dev/tutorial/data is used for log files by proxy, archive and storage.

### Initialize WalB device

Type the following command only *ONCE*.

```
sudo walb-tools/binsrc/wdevc format-ldev /dev/tutorial/wlog /dev/tutorial/wdata
```

### Create walb device(wdev)

If you reboot system, then insmod `walb-mod.ko` and type the following command.

```
sudo walb-tools/binsrc/wdevc create-wdev /dev/tutorial/wlog /dev/tutorial/wdata -n walb-tutorial-device
```

### Start WalB server

```
cd walb-tools
sudo binsrc/walb-storage -b /mnt/tutorial/s0/ -l /mnt/tutorial/s0.log -archive localhost:10200 -p 10000 -bg 1 -proxy localhost:10100 -fg 2 -id s0 &
sudo binsrc/walb-proxy -b /mnt/tutorial/p0/ -l /mnt/tutorial/p0.log -p 10100 -bg 1 -fg 2 -id p0 &
sudo binsrc/walb-archive -b ${DATA}/a0/ -vg tutorial -l /mnt/tutorial/a0.log -p 10200 -fg 2 -id a0 &
```

## How to use WalB on ipython

## Run ipython and exec tutorial.py

```
cd walb-tools
sudo ipython
execfile('misc/tutorial.py')
```

## Initialize VOL

VOL is defined as 'vol' in `tutorial.py`.

```
In []: walbc.init_storage(s0, VOL, wdev.path)
```

## Check WalB status

```
In []: walbc.get_state_all(VOL)
```

```
s0 localhost:10000 storage Standby
p0 localhost:10100 proxy Clear
a0 localhost:10200 archive Clear
```

## Create a file system on `/dev/walb/walb-tutorial-device`.


Suspend ipython or on the other terminal, initialize `/dev/walb/walb-tutorial-device` by ext4.

```
sudo mkfs.ext4 /dev/walb/walb-tutorial-device
```

## Mount it

```
sudo mkdir -p /mnt/tmp
sudo mount /dev/walb/walb-tutorial-device /mnt/tmp
```
`/mnt/tmp` is the file system on WalB.

## full-backup

Back to ipython commandline,
* Change the status of `storage` to `SyncReady`.

See ![state](state.png).

```
In []: walbc.stop(s0, VOL)
```

* Start full backup


By `full_backup` command, walb-storage reads all blocks of wdev and transters them to walb-archive.

Verify the status to full backup
```
In []: walbc.get_state_all(VOL)
s0 localhost:10000 storage SyncReady
p0 localhost:10100 proxy Started
a0 localhost:10200 archive SyncReady
```

```
In []: walbc.full_backup(s0, VOL)
```

See the status after full backup
```
In []: walbc.get_state_all(VOL)
s0 localhost:10000 storage Target
p0 localhost:10100 proxy Started
a0 localhost:10200 archive Archived
```

## Take a snapshot and restore it

* Make a file on `/mnt/tmp` and umount it to flush it completely.

```
sudo sh -c "echo abc > /mnt/tmp/test.txt"
sudo umount /dev/walb/walb-tutorial-device
```

* Take a snapshot on ipython.

```
In []: walbc.snapshot(s0, VOL, [a0])
Out[]: 8
```
The displayed value is the gid assigned to the snapshot.

* Rectore the snapshot on archive server `a0`.

```
In []: walbc.restore(a0, VOL, 8)
```

* `get_restored_path` shows the full path of the LVM snapshot.

```
In []: walbc.get_restored_path(a0, VOL, 8)
Out[]: '/dev/tutorial/r_vol_8'
```

* Mount the snapshot.

```
sudo mount /dev/tutorial/r_vol_8 /mnt/tmp
```

* Verify the file written in /mnt/tmp.

```
cat /mnt/tmp/test.txt
```

* Delete the snapshot

`walbc.del_restored` deletes a LVM snapshot after umounting it.

```
sudo umount /mnt/tmp
```
```
In []: walbc.del_restored(a0, VOL, 8)
```

## Merge wdiffs

By merging many wdiffs, duplicate data are removed then total size of wdiffs may be reduced.

`print_diff_list` shows a list of wdiffs.

```
In []: walbc.print_diff_list(a0,VOL)
|0|-->|1| -- 2017-05-24T04:49:40 4128
|1|-->|2| -- 2017-05-24T05:00:15 9427
|2|-->|3| M- 2017-05-24T05:00:40 8280
|3|-->|4| M- 2017-05-24T05:00:45 8688
|4|-->|5| M- 2017-05-24T05:00:49 9309
|5|-->|6| M- 2017-05-24T05:01:36 8567
|6|-->|7| M- 2017-05-24T05:02:10 4128
|7|-->|8| -- 2017-05-24T05:13:31 4128
```

You can merge wdiffs marked by `M`.
Merge wdiffs from 2 to 8.
```
In [44]: walbc.merge(a0, VOL, 2, 7)
```
```
In []: walbc.print_diff_list(a0,VOL)
|0|-->|1| -- 2017-05-24T04:49:40 4128
|1|-->|2| -- 2017-05-24T05:00:15 9427
|2|-->|7| M- 2017-05-24T05:02:10 9927
|7|-->|8| -- 2017-05-24T05:13:31 4128
```

The results shows that 8280, 8688, 9309, 8567, 4128-bytes wdiffs are merged to one 9927-byte wdiffs.

## Apply wdiffs

If an old snapshot is unnecessary, then file size can be reduced by applying wdiffs to the old snapshot.
```
In []: walbc.print_diff_list(a0,VOL)
|0|-->|1| -- 2017-05-24T04:49:40 4128
|1|-->|2| -- 2017-05-24T05:00:15 9427
|2|-->|7| M- 2017-05-24T05:02:10 9927
|7|-->|8| -- 2017-05-24T05:13:31 4128
```
Apply 0..8 wdiffs to 0.

```
In []: walbc.print_diff_list(a0,VOL)

```
0..8 wdiffs are removed.

## Hash-backup

Hash-backup compares the data between a storage and an archive and
transffers minimum wdiffs, then the data size to be transffered is smaller than full-backup.


* Stop s0 and hash-backup.
```
In []: walbc.get_state_all(VOL)
s0 localhost:10000 storage Target
p0 localhost:10100 proxy Started
a0 localhost:10200 archive Archived
```

```
In []: walbc.stop(s0,VOL)
In []: walbc.get_state_all(VOL)
s0 localhost:10000 storage Stopped
p0 localhost:10100 proxy Started
a0 localhost:10200 archive Archived
```

```
In []: walbc.hash_backup(s0,VOL)
Out[]: 5
```

## Replication

Add an archive server and exec asynchronous replication between them.

* Add a volume
Make `tutorial2-disk` and make a volume group named as `tutorial2`.

```
cd
dd if=/dev/zero of=tutorial2-disk bs=1M count=50
sudo losetup /dev/loop1 tutorial2-disk
sudo pvcreate /dev/loop1
sudo vgcreate tutorial2 /dev/loop1
sudo mkdir -p /mnt/tutorial/a1
```
* Start a new walb-archive server
```
sudo /home/vagrant/walb-tools/binsrc/walb-archive -b /mnt/tutorial/a1/ -vg tutorial2 -l /mnt/tutorial/a1.log -p 10201 -fg 2 -id a1 &
```

* Run tutorial2.py
```
cd walb-tools
sudo ipython
In []: execfile('misc/tutorial2.py')
```

* Check the current status
```
In []: walbc.get_state_all(VOL)
s0 localhost:10000 storage Target
p0 localhost:10100 proxy Started
a0 localhost:10200 archive Archived
a1 localhost:10201 archive Clear
```

* Change the status of `a1` from `Clear` to `SyncReady`.

```
In []: walbc._init(a1, VOL)
In []: walbc.get_state_all(VOL)
s0 localhost:10000 storage Target
p0 localhost:10100 proxy Started
a0 localhost:10200 archive Archived
a1 localhost:10201 archive SyncReady
```

* Replication once.

```
In []: walbc.replicate_once(a0, VOL, a1)
Out[]: 22
```

* Restore 22 in a1 then, `/dev/tutorial2/wr_vol_22` is created.
```
In []: walbc.restore(a1, VOL, 22)
```

* Restore 22 in a0.
```
In []: walbc.restore(a0, VOL, 22)
```

Verify the sha1 of two volumes.
```
sudo sha1sum /dev/tutorial/wr_vol_22
ff24c0b72da6491d6ec2288579257e7c423cedb3  /dev/tutorial/wr_vol_22
sudo sha1sum /dev/tutorial2/wr_vol_22
ff24c0b72da6491d6ec2288579257e7c423cedb3  /dev/tutorial2/wr_vol_22
```

* Replication with synchronized mode
After `replicate_once`, `a0` and `a1` are not synchronized.
```
In []: walbc.is_synchronizing(a1, VOL)
Out[]: False
```

* Transition to synchronized mode.

```
In []: walbc.synchronize(a0, VOL, a1)
In []: walbc.is_synchronizing(a1, VOL)
Out[]: True
```

Use `replicate` for synchronized mode from the beginning.

